resource "google_compute_target_pool" "ruby_cluster" {
  name = "ruby-cluster"

  instances = ["${element(google_compute_instance.app.*.self_link, count.index)}"]

  health_checks = ["${google_compute_http_health_check.ruby_http_port.self_link}"]
}

resource "google_compute_http_health_check" "ruby_http_port" {
  name               = "ruby-http-port"
  check_interval_sec = 3
  timeout_sec        = 1
  port               = 9292
  request_path       = "/"
}

resource "google_compute_global_forwarding_rule" "ruby-forwarding" {
  name       = "ruby-forwarding"
  target     = "${google_compute_target_pool.ruby_cluster.self_link}"
  port_range = 9292
}
